rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== دوال مساعدة =====
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserToken() {
      return request.auth.token;
    }

    // التحقق من مالك النظام (النمط الموحد is*)
    function isSystemOwner() {
      return isAuthenticated() && (
        getUserToken().isSystemOwner == true ||
        getUserToken().role == 'system_owner'
      );
    }

    // التحقق من أدمن النظام (النمط الموحد is*)
    function isSystemAdmin() {
      return isAuthenticated() && (
        getUserToken().isSystemAdmin == true ||
        getUserToken().role == 'system_admin'
      );
    }

    // التحقق من مالك المؤسسة (النمط الموحد is*)
    function isOrgOwner() {
      return isAuthenticated() && (
        getUserToken().isOrgOwner == true ||
        getUserToken().role == 'org_owner'
      );
    }

    // التحقق من أدوار المؤسسات (النمط الموحد is*)
    function isOrgAdmin() {
      return isAuthenticated() && (
        getUserToken().isOrgAdmin == true ||
        getUserToken().role == 'org_admin'
      );
    }

    function isOrgSupervisor() {
      return isAuthenticated() && (
        getUserToken().isOrgSupervisor == true ||
        getUserToken().role == 'org_supervisor'
      );
    }

    function isOrgEngineer() {
      return isAuthenticated() && (
        getUserToken().isOrgEngineer == true ||
        getUserToken().role == 'org_engineer'
      );
    }

    function isOrgTechnician() {
      return isAuthenticated() && (
        getUserToken().isOrgTechnician == true ||
        getUserToken().role == 'org_technician'
      );
    }

    function isOrgAssistant() {
      return isAuthenticated() && (
        getUserToken().isOrgAssistant == true ||
        getUserToken().role == 'org_assistant'
      );
    }

    // التحقق من صلاحيات النظام العليا
    function hasSystemAccess() {
      return isSystemOwner() || isSystemAdmin();
    }

    // التحقق من صلاحيات إدارية عامة (النظام الموحد)
    function hasAdminAccess() {
      return hasSystemAccess() || isOrgOwner() ||
             isOrgAdmin() || isOrgSupervisor() || isOrgEngineer() ||
             isOrgTechnician() || isOrgAssistant();
    }

    // ===== الصلاحيات الديناميكية (بدون تخزين) =====

    // التحقق من صلاحية إدارة النظام
    function canManageSystem() {
      return isSystemOwner();
    }

    // التحقق من صلاحية إدارة المستخدمين
    function canManageUsers() {
      return hasSystemAccess();
    }

    // التحقق من صلاحية إدارة المؤسسات
    function canManageOrganization() {
      return hasSystemAccess() || isOrgOwner();
    }

    // التحقق من صلاحية إدارة المشاريع
    function canManageProjects() {
      return hasSystemAccess() || isOrgOwner() || isOrgAdmin();
    }

    // التحقق من صلاحية عرض التقارير
    function canViewReports() {
      return hasSystemAccess() || isOrgOwner() ||
             isOrgAdmin() || isOrgSupervisor() || isOrgEngineer();
    }

    // التحقق من صلاحية إنشاء المهام
    function canCreateTasks() {
      return hasSystemAccess() || isOrgOwner() ||
             isOrgAdmin() || isOrgSupervisor() || isOrgEngineer() || isOrgTechnician() ||
             isIndependent() || // المستخدمون المستقلون يمكنهم إنشاء المهام
             isIndividualAccount(); // أصحاب الحسابات الفردية يمكنهم إنشاء المهام
    }

    // التحقق من المستخدم المستقل (النمط الموحد is*)
    function isIndependent() {
      return isAuthenticated() && (
        getUserToken().isIndependent == true ||
        getUserToken().role == 'independent'
      );
    }

    // التحقق من نوع الحساب الفردي
    function isIndividualAccount() {
      return isAuthenticated() && getUserToken().accountType == 'individual';
    }

    // التحقق من المستخدم الفردي (دور مستقل أو نوع حساب فردي)
    function isIndividualUser() {
      return isIndependent() || isIndividualAccount();
    }

    // التحقق من الصلاحيات المخصصة
    function hasCustomPermission(permission) {
      return isAuthenticated() &&
        getUserToken().customPermissions != null &&
        getUserToken().customPermissions is list &&
        permission in getUserToken().customPermissions;
    }

    // ===== قواعد فئات المهام =====
    match /taskCategories/{categoryId} {
      // السماح للجميع بالقراءة
      allow read: if isAuthenticated();

      // السماح للأدمن بالكتابة
      allow write: if hasAdminAccess();
    }

    // ===== قواعد المستخدمين (النمط الموحد) =====
    match /users/{userId} {
      // قراءة البيانات الشخصية
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        canManageUsers() ||
        hasCustomPermission('users:view') ||
        hasAdminAccess()
      );

      // كتابة البيانات الشخصية
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        canManageUsers() ||
        hasCustomPermission('users:edit') ||
        hasAdminAccess()
      );
    }

    // ===== قواعد المهام (النمط الموحد) =====
    match /tasks/{taskId} {
      // قراءة المهام
      allow read: if isAuthenticated() && (
        hasCustomPermission('tasks:view') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent() ||
        resource.data.createdBy == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );

      // إنشاء المهام
      allow create: if isAuthenticated() && (
        hasCustomPermission('tasks:create') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent()
      );

      // تعديل المهام
      allow update: if isAuthenticated() && (
        hasCustomPermission('tasks:edit') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent() ||
        resource.data.createdBy == request.auth.uid
      );

      // حذف المهام
      allow delete: if isAuthenticated() && (
        hasCustomPermission('tasks:delete') ||
        hasAdminAccess() ||
        isIndependent() ||
        resource.data.createdBy == request.auth.uid
      );
    }

    // ===== قواعد المؤسسات (النمط الموحد) =====
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (
        canManageOrganization() ||
        hasSystemAccess() ||
        getUserToken().organizationId == orgId
      );

      allow write: if canManageOrganization() || hasSystemAccess() || isOrgOwner();
    }

    // ===== إعدادات النظام (النمط الموحد) =====
    match /system/{document=**} {
      allow read: if isAuthenticated() && (
        hasCustomPermission('settings:view') ||
        hasSystemAccess()
      );
      allow write: if canManageSystem() || hasSystemAccess();
    }

    // ===== قواعد خاصة للحسابات الفردية (النمط الموحد) =====
    match /individualData/{userId} {
      // أصحاب الحسابات الفردية يمكنهم الوصول لبياناتهم الشخصية
      allow read, write: if isAuthenticated() && (
        request.auth.uid == userId && isIndividualAccount()
      );
    }

    // ===== قواعد طلبات المؤسسات (النمط الموحد) =====
    match /organizationRequests/{requestId} {
      allow read: if isAuthenticated() && (
        hasSystemAccess() ||
        resource.data.userId == request.auth.uid
      );

      allow create: if isAuthenticated() && isIndependent();

      allow update: if hasSystemAccess();

      allow delete: if hasSystemAccess();
    }

    // ===== قواعد دعوات المؤسسات (النمط الموحد) =====
    match /organizationInvitations/{invitationId} {
      allow read: if isAuthenticated() && (
        hasSystemAccess() ||
        isOrgOwner() ||
        resource.data.invitedUserId == request.auth.uid
      );

      allow create: if isAuthenticated() && (
        hasSystemAccess() || isOrgOwner()
      );

      allow update: if isAuthenticated() && (
        hasSystemAccess() ||
        isOrgOwner() ||
        resource.data.invitedUserId == request.auth.uid
      );

      allow delete: if hasSystemAccess() || isOrgOwner();
    }

    // ===== قواعد عامة للمجموعات الأخرى (النمط الموحد) =====
    match /{document=**} {
      // قاعدة احتياطية - السماح للمستخدمين المسجلين بالقراءة والأدمن بالكتابة
      allow read: if isAuthenticated() && (
        hasAdminAccess() ||
        isIndividualAccount() ||
        isIndependent()
      );
      allow write: if hasAdminAccess() || isIndividualAccount();
    }
  }
}
