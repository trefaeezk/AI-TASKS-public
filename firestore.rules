rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== دوال مساعدة =====
    function isAuthenticated() {
      return request.auth != null;
    }

    function getUserToken() {
      return request.auth.token;
    }

    // التحقق من مالك النظام
    function isSystemOwner() {
      return isAuthenticated() && (
        getUserToken().system_owner == true ||
        getUserToken().role == 'system_owner'
      );
    }

    // التحقق من أدمن النظام
    function isSystemAdmin() {
      return isAuthenticated() && (
        getUserToken().system_admin == true ||
        getUserToken().role == 'system_admin'
      );
    }

    // التحقق من مالك المؤسسة
    function isOrgOwner() {
      return isAuthenticated() && (
        getUserToken().org_owner == true ||
        getUserToken().role == 'org_owner'
      );
    }

    // التحقق من أدوار المؤسسات
    function isOrgAdmin() {
      return isAuthenticated() && getUserToken().role == 'org_admin';
    }

    function isOrgSupervisor() {
      return isAuthenticated() && getUserToken().role == 'org_supervisor';
    }

    function isOrgEngineer() {
      return isAuthenticated() && getUserToken().role == 'org_engineer';
    }

    function isOrgTechnician() {
      return isAuthenticated() && getUserToken().role == 'org_technician';
    }

    function isOrgAssistant() {
      return isAuthenticated() && getUserToken().role == 'org_assistant';
    }

    // التحقق من صلاحيات النظام العليا
    function hasSystemAccess() {
      return isSystemOwner() || isSystemAdmin();
    }

    // التحقق من صلاحيات إدارية عامة (النظام الموحد)
    function hasAdminAccess() {
      return hasSystemAccess() || isOrgOwner() ||
             isOrgAdmin() || isOrgSupervisor() || isOrgEngineer() ||
             isOrgTechnician() || isOrgAssistant();
    }

    // ===== الصلاحيات الجديدة =====

    // التحقق من صلاحية إدارة النظام
    function canManageSystem() {
      return isAuthenticated() && (
        getUserToken().canManageSystem == true ||
        isSystemOwner()
      );
    }

    // التحقق من صلاحية إدارة المستخدمين
    function canManageUsers() {
      return isAuthenticated() && (
        getUserToken().canManageUsers == true ||
        hasSystemAccess()
      );
    }

    // التحقق من صلاحية إدارة المؤسسات
    function canManageOrganization() {
      return isAuthenticated() && (
        getUserToken().canManageOrganization == true ||
        hasSystemAccess() || isOrgOwner()
      );
    }

    // التحقق من صلاحية إدارة المشاريع
    function canManageProjects() {
      return isAuthenticated() && (
        getUserToken().canManageProjects == true ||
        hasSystemAccess() || isOrgOwner() || isOrgAdmin()
      );
    }

    // التحقق من صلاحية عرض التقارير
    function canViewReports() {
      return isAuthenticated() && (
        getUserToken().canViewReports == true ||
        hasSystemAccess() || isOrgOwner() ||
        isOrgAdmin() || isOrgSupervisor() || isOrgEngineer()
      );
    }

    // التحقق من صلاحية إنشاء المهام
    function canCreateTasks() {
      return isAuthenticated() && (
        getUserToken().canCreateTasks == true ||
        hasSystemAccess() || isOrgOwner() ||
        isOrgAdmin() || isOrgSupervisor() || isOrgEngineer() || isOrgTechnician() ||
        isIndependent() || // المستخدمون المستقلون يمكنهم إنشاء المهام
        isIndividualAccount() // أصحاب الحسابات الفردية يمكنهم إنشاء المهام
      );
    }

    // التحقق من المستخدم المستقل
    function isIndependent() {
      return isAuthenticated() && getUserToken().role == 'independent';
    }

    // التحقق من نوع الحساب الفردي
    function isIndividualAccount() {
      return isAuthenticated() && getUserToken().accountType == 'individual';
    }

    // التحقق من المستخدم الفردي (دور مستقل أو نوع حساب فردي)
    function isIndividualUser() {
      return isIndependent() || isIndividualAccount();
    }

    // التحقق من الصلاحيات المخصصة
    function hasCustomPermission(permission) {
      return isAuthenticated() &&
        getUserToken().customPermissions != null &&
        getUserToken().customPermissions is list &&
        permission in getUserToken().customPermissions;
    }

    // ===== قواعد فئات المهام =====
    match /taskCategories/{categoryId} {
      // السماح للجميع بالقراءة
      allow read: if isAuthenticated();

      // السماح للأدمن بالكتابة
      allow write: if hasAdminAccess();
    }

    // ===== قواعد المستخدمين =====
    match /users/{userId} {
      // قراءة البيانات الشخصية
      allow read: if isAuthenticated() && (
        request.auth.uid == userId ||
        canManageUsers() ||
        hasCustomPermission('users:view') ||
        hasAdminAccess()
      );

      // كتابة البيانات الشخصية
      allow write: if isAuthenticated() && (
        request.auth.uid == userId ||
        canManageUsers() ||
        hasCustomPermission('users:edit') ||
        hasAdminAccess()
      );
    }

    // ===== قواعد المهام =====
    match /tasks/{taskId} {
      // قراءة المهام
      allow read: if isAuthenticated() && (
        hasCustomPermission('tasks:view') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent() || // المستخدمون المستقلون يمكنهم قراءة المهام
        resource.data.createdBy == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid
      );

      // إنشاء المهام
      allow create: if isAuthenticated() && (
        hasCustomPermission('tasks:create') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent() // المستخدمون المستقلون يمكنهم إنشاء المهام
      );

      // تعديل المهام
      allow update: if isAuthenticated() && (
        hasCustomPermission('tasks:edit') ||
        canCreateTasks() ||
        hasAdminAccess() ||
        isIndependent() || // المستخدمون المستقلون يمكنهم تعديل المهام
        resource.data.createdBy == request.auth.uid
      );

      // حذف المهام
      allow delete: if isAuthenticated() && (
        hasCustomPermission('tasks:delete') ||
        hasAdminAccess() ||
        isIndependent() || // المستخدمون المستقلون يمكنهم حذف المهام
        resource.data.createdBy == request.auth.uid
      );
    }

    // ===== قواعد المؤسسات =====
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && (
        canManageOrganization() ||
        hasSystemAccess() ||
        getUserToken().organizationId == orgId
      );

      allow write: if canManageOrganization() || hasSystemAccess() || isOrgOwner();
    }

    // ===== إعدادات النظام =====
    match /system/{document=**} {
      allow read: if isAuthenticated() && (
        hasCustomPermission('settings:view') ||
        hasSystemAccess()
      );
      allow write: if canManageSystem() || hasSystemAccess();
    }

    // ===== قواعد خاصة للحسابات الفردية =====
    match /individualData/{userId} {
      // أصحاب الحسابات الفردية يمكنهم الوصول لبياناتهم الشخصية
      allow read, write: if isAuthenticated() && (
        request.auth.uid == userId && isIndividualAccount()
      );
    }

    // ===== قواعد عامة للمجموعات الأخرى =====
    match /{document=**} {
      // قاعدة احتياطية - السماح للمستخدمين المسجلين بالقراءة والأدمن بالكتابة
      allow read: if isAuthenticated() && (
        hasAdminAccess() ||
        isIndividualAccount() || // أصحاب الحسابات الفردية يمكنهم القراءة
        isIndependent() // المستخدمون المستقلون يمكنهم القراءة
      );
      allow write: if hasAdminAccess() || isIndividualAccount();
    }
  }
}
