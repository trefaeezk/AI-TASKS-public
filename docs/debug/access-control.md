# إدارة الصلاحيات لصفحة التشخيص

## نظرة عامة

صفحة التشخيص هي أداة قوية تتيح الوصول إلى وظائف متقدمة في النظام. نظرًا لحساسية هذه الوظائف، فإن الوصول إلى صفحة التشخيص مقيد **لمالك المشروع فقط**.

## مستويات الصلاحيات

### مالك المشروع (Owner)

- **الصلاحيات**: وصول كامل إلى جميع وظائف صفحة التشخيص
- **التعريف**: المستخدم الذي لديه صلاحية `owner = true` في الـ Custom Claims
- **كيفية التعيين**: يتم تعيين مالك المشروع من خلال وظيفة `setOwnerRole` في Firebase Functions

### مسؤول النظام (Admin)

- **الصلاحيات**: لا يمكنه الوصول إلى صفحة التشخيص
- **التعريف**: المستخدم الذي لديه صلاحية `admin = true` في الـ Custom Claims
- **كيفية التعيين**: يتم تعيين مسؤول النظام من خلال وظيفة `setAdminRole` في Firebase Functions

### المستخدم العادي (User)

- **الصلاحيات**: لا يمكنه الوصول إلى صفحة التشخيص
- **التعريف**: أي مستخدم ليس لديه صلاحية `owner = true` أو `admin = true` في الـ Custom Claims

## آلية التحقق من الصلاحيات

### في الواجهة الأمامية (Frontend)

```typescript
// مثال على التحقق من صلاحيات المستخدم في الواجهة الأمامية
import { useAuth } from '@/context/AuthContext';

function DebugPage() {
  const { userClaims } = useAuth();
  
  // التحقق من أن المستخدم هو مالك المشروع
  if (!userClaims?.owner) {
    return <AccessDeniedPage />;
  }
  
  // عرض صفحة التشخيص
  return <DebugPageContent />;
}
```

### في الخدمات السحابية (Backend)

```typescript
// مثال على التحقق من صلاحيات المستخدم في الخدمات السحابية
export const generateAndSendOTP = functions.https.onCall(async (_, context) => {
  // التحقق من وجود مستخدم مسجل الدخول
  if (!context.auth) {
    throw new functions.https.HttpsError(
      'unauthenticated',
      'يجب تسجيل الدخول لإنشاء رمز التحقق'
    );
  }

  // التحقق من أن المستخدم هو مالك المشروع
  const isOwner = context.auth.token.owner === true;

  if (!isOwner) {
    throw new functions.https.HttpsError(
      'permission-denied',
      'غير مصرح لك بإنشاء رمز التحقق'
    );
  }
  
  // تنفيذ الوظيفة
  // ...
});
```

## كيفية تعيين مالك المشروع

يمكن تعيين مالك المشروع من خلال وظيفة `setOwnerRole` في Firebase Functions. هذه الوظيفة متاحة فقط للمستخدمين الذين لديهم صلاحية `owner = true` بالفعل.

### باستخدام واجهة المستخدم

1. قم بتسجيل الدخول باستخدام حساب مالك المشروع.
2. انتقل إلى صفحة `المستخدمين`.
3. ابحث عن المستخدم الذي تريد تعيينه كمالك للمشروع.
4. اضغط على زر `تعيين كمالك`.
5. قم بتأكيد العملية.

### باستخدام Firebase Functions مباشرة

```typescript
// مثال على استدعاء وظيفة setOwnerRole
import { httpsCallable } from 'firebase/functions';
import { functions } from '@/lib/firebase';

const setOwnerRole = httpsCallable(functions, 'setOwnerRole');
await setOwnerRole({ uid: 'user-id', isOwner: true });
```

## إدارة رموز التحقق (OTP)

رموز التحقق (OTP) هي طبقة إضافية من الأمان للوصول إلى صفحة التشخيص. يتم تخزين هذه الرموز في مجموعة `debugOTP` في Firestore.

### هيكل بيانات رمز التحقق

```typescript
interface OTPData {
  userId: string;        // معرف المستخدم
  userEmail: string;     // البريد الإلكتروني للمستخدم
  otp: string;           // رمز التحقق
  createdAt: Timestamp;  // وقت إنشاء الرمز
  expiryTime: Timestamp; // وقت انتهاء صلاحية الرمز
  used: boolean;         // هل تم استخدام الرمز
}
```

### دورة حياة رمز التحقق

1. **الإنشاء**: يتم إنشاء رمز التحقق عند النقر على زر `إنشاء رمز تحقق جديد`.
2. **الإرسال**: يتم إرسال الرمز إلى البريد الإلكتروني المرتبط بحساب المستخدم.
3. **التحقق**: يتم التحقق من صحة الرمز عند إدخاله.
4. **الاستخدام**: يتم تعيين حالة الرمز إلى "مستخدم" بعد التحقق منه بنجاح.
5. **انتهاء الصلاحية**: تنتهي صلاحية الرمز بعد 30 دقيقة من وقت الإنشاء.

## سجلات الأمان

يتم تسجيل جميع الأحداث المتعلقة بصفحة التشخيص في سجلات النظام. يمكن الوصول إلى هذه السجلات من خلال لوحة تحكم Firebase.

### أنواع الأحداث المسجلة

- محاولات الوصول إلى صفحة التشخيص
- إنشاء رموز التحقق
- التحقق من رموز التحقق
- تنفيذ وظائف التشخيص

## أفضل الممارسات الأمنية

1. **تقييد الوصول**: حافظ على تقييد الوصول إلى صفحة التشخيص لمالك المشروع فقط.
2. **التحقق بخطوتين**: استمر في استخدام رموز التحقق (OTP) للوصول إلى صفحة التشخيص.
3. **تسجيل الأحداث**: تأكد من تسجيل جميع الأحداث المتعلقة بصفحة التشخيص.
4. **مراجعة السجلات**: قم بمراجعة سجلات الأمان بانتظام للكشف عن أي نشاط مشبوه.
5. **تحديث الصلاحيات**: قم بمراجعة وتحديث صلاحيات المستخدمين بانتظام.

## استكشاف الأخطاء وإصلاحها

### مشكلة: المستخدم لا يمكنه الوصول إلى صفحة التشخيص رغم أنه مالك المشروع

**الحلول المحتملة**:

1. تحقق من الـ Custom Claims للمستخدم باستخدام وظيفة `getUserClaims` في Firebase Functions.
2. تأكد من أن المستخدم لديه صلاحية `owner = true` في الـ Custom Claims.
3. إذا لم يكن لديه الصلاحية، قم بتعيينها باستخدام وظيفة `setOwnerRole`.
4. قم بتسجيل الخروج وإعادة تسجيل الدخول لتحديث الـ Custom Claims.

### مشكلة: خطأ في تعيين مالك المشروع

**الحلول المحتملة**:

1. تأكد من أنك تستخدم حساب مالك المشروع لتعيين مالك جديد.
2. تحقق من وجود المستخدم الذي تريد تعيينه كمالك.
3. تحقق من سجلات Firebase Functions للحصول على مزيد من المعلومات حول الخطأ.

## ملاحظات هامة

- **لا تقم بتعيين العديد من المستخدمين كمالكين للمشروع**، حيث يزيد ذلك من مخاطر الأمان.
- **قم بتغيير مالك المشروع فقط عند الضرورة**، مثل تغيير المسؤول عن المشروع.
- **تأكد من توثيق أي تغييرات في صلاحيات المستخدمين**، خاصة تعيين مالك المشروع.
