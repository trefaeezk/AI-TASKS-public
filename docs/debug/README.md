# وثائق صفحة التشخيص

## نظرة عامة

صفحة التشخيص هي أداة قوية مخصصة **لمالك المشروع فقط**. تتيح هذه الصفحة إمكانية تشخيص وإصلاح المشكلات في النظام، واختبار الوظائف المختلفة، وإدارة إعدادات النظام المتقدمة.

![صفحة التشخيص](./images/debug-page.png)

## الوصول إلى صفحة التشخيص

### متطلبات الوصول

للوصول إلى صفحة التشخيص، يجب أن تتوفر الشروط التالية:

1. **أن تكون مالك المشروع**: فقط المستخدم الذي لديه صلاحية `owner = true` في الـ Custom Claims يمكنه الوصول إلى هذه الصفحة.
2. **تسجيل الدخول**: يجب أن تكون مسجل الدخول إلى النظام.
3. **التحقق بخطوتين**: يجب إدخال رمز التحقق (OTP) الذي يتم إرساله إلى بريدك الإلكتروني.

### خطوات الوصول

1. قم بتسجيل الدخول إلى النظام باستخدام حساب مالك المشروع.
2. انتقل إلى `الإعدادات` من القائمة الجانبية.
3. اضغط على `التشخيص` في قائمة الإعدادات.
4. سيتم عرض شاشة التحقق من الهوية.
5. اضغط على زر `إنشاء رمز تحقق جديد` لإرسال رمز التحقق إلى بريدك الإلكتروني.
6. أدخل رمز التحقق المستلم في الحقل المخصص.
7. اضغط على زر `تحقق` للدخول إلى صفحة التشخيص.

## ميزات صفحة التشخيص

### 1. نظام البريد الإلكتروني

يستخدم النظام خدمة البريد الإلكتروني لإرسال رموز التحقق (OTP) وإشعارات النظام. تم تكوين النظام لاستخدام SMTP كطريقة أساسية لإرسال البريد الإلكتروني.

#### ملاحظات:

- يستخدم النظام خدمة SMTP لإرسال البريد الإلكتروني.
- إذا لم يصل البريد الإلكتروني، تحقق من مجلد البريد غير المرغوب فيه (Spam).
- يمكن تكوين إعدادات SMTP من خلال ملف `.env` أو إعدادات Firebase Functions.

### 2. إدارة المستخدمين

تتيح هذه الميزة إدارة المستخدمين في النظام، بما في ذلك:

- عرض قائمة المستخدمين
- تعطيل/تفعيل حسابات المستخدمين
- تعيين أدوار المستخدمين (مالك، مسؤول، مستخدم عادي)
- حذف المستخدمين

#### كيفية الاستخدام:

1. انتقل إلى تبويب `المستخدمين` في صفحة التشخيص.
2. استخدم الأزرار المتاحة لإدارة المستخدمين.

### 3. إعدادات النظام

تتيح هذه الميزة تكوين إعدادات النظام المختلفة، مثل:

- إعدادات البريد الإلكتروني
- إعدادات الأمان
- إعدادات الواجهة

#### كيفية الاستخدام:

1. انتقل إلى تبويب `الإعدادات` في صفحة التشخيص.
2. قم بتعديل الإعدادات حسب الحاجة.
3. اضغط على زر `حفظ` لتطبيق التغييرات.

## آلية التحقق من الهوية

### رمز التحقق (OTP)

يستخدم النظام رمز التحقق لمرة واحدة (OTP) للتحقق من هوية المستخدم قبل الوصول إلى صفحة التشخيص. يتم إنشاء هذا الرمز وإرساله إلى البريد الإلكتروني المرتبط بحساب المستخدم.

#### خصائص رمز التحقق:

- **الصلاحية**: 30 دقيقة من وقت الإنشاء
- **الاستخدام**: يمكن استخدام الرمز مرة واحدة فقط
- **الطول**: 6 أرقام

### آلية إرسال رمز التحقق

1. عند النقر على زر `إنشاء رمز تحقق جديد`، يتم استدعاء وظيفة `generateAndSendOTP` من Firebase Functions.
2. تقوم الوظيفة بإنشاء رمز تحقق عشوائي مكون من 6 أرقام.
3. يتم تخزين الرمز في مجموعة `debugOTP` في Firestore مع وقت انتهاء الصلاحية.
4. يتم إرسال الرمز إلى البريد الإلكتروني المرتبط بحساب المستخدم باستخدام SMTP.
5. إذا فشل إرسال البريد الإلكتروني باستخدام SMTP، يتم استخدام Resend API كخطة بديلة.

### آلية التحقق من الرمز

1. عند إدخال الرمز والنقر على زر `تحقق`، يتم استدعاء وظيفة `verifyOTP` من Firebase Functions.
2. تقوم الوظيفة بالتحقق من صحة الرمز ووقت انتهاء الصلاحية.
3. إذا كان الرمز صحيحًا ولم تنته صلاحيته، يتم تعيين حالة الرمز إلى "مستخدم" ويتم السماح للمستخدم بالوصول إلى صفحة التشخيص.
4. إذا كان الرمز غير صحيح أو انتهت صلاحيته، يتم عرض رسالة خطأ للمستخدم.

## الأمان والحماية

صفحة التشخيص محمية بعدة طبقات من الأمان:

1. **التحقق من الصلاحيات**: فقط المستخدم الذي لديه صلاحية `owner = true` يمكنه الوصول إلى الصفحة.
2. **التحقق بخطوتين**: يجب إدخال رمز التحقق (OTP) للوصول إلى الصفحة.
3. **تسجيل الأحداث**: يتم تسجيل جميع الأحداث المتعلقة بصفحة التشخيص في سجلات النظام.
4. **انتهاء الجلسة**: تنتهي جلسة صفحة التشخيص بعد 30 دقيقة من عدم النشاط.

## استكشاف الأخطاء وإصلاحها

### مشكلة: لا يمكن الوصول إلى صفحة التشخيص

**الحلول المحتملة**:

1. تأكد من أنك مسجل الدخول باستخدام حساب مالك المشروع.
2. تأكد من أن لديك صلاحية `owner = true` في الـ Custom Claims.
3. حاول تسجيل الخروج وإعادة تسجيل الدخول.

### مشكلة: لم يصل رمز التحقق إلى البريد الإلكتروني

**الحلول المحتملة**:

1. تحقق من مجلد البريد غير المرغوب فيه (Spam).
2. تأكد من أن عنوان البريد الإلكتروني المرتبط بحسابك صحيح.
3. تحقق من إعدادات SMTP في ملف `.env` أو إعدادات Firebase Functions.
4. اضغط على زر `إنشاء رمز تحقق جديد` مرة أخرى.

### مشكلة: رمز التحقق غير صالح

**الحلول المحتملة**:

1. تأكد من إدخال الرمز الصحيح.
2. تحقق من وقت انتهاء صلاحية الرمز (30 دقيقة من وقت الإنشاء).
3. اضغط على زر `إنشاء رمز تحقق جديد` للحصول على رمز جديد.

## ملاحظات هامة

- **لا تشارك رمز التحقق** مع أي شخص، حتى لو ادعى أنه من فريق الدعم الفني.
- **لا تترك صفحة التشخيص مفتوحة** دون مراقبة.
- **قم بتسجيل الخروج** بعد الانتهاء من استخدام صفحة التشخيص.
- **استخدم صفحة التشخيص بحذر**، حيث يمكن أن تؤثر التغييرات التي تجريها على النظام بأكمله.
