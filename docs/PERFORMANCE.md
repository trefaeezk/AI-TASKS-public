# تحسين الأداء وفهارس قاعدة البيانات

هذا المستند يشرح استراتيجيات تحسين الأداء المستخدمة في تطبيق إدارة المهام، مع التركيز على فهارس Firestore.

## فهارس Firestore

تُستخدم فهارس Firestore لتحسين أداء الاستعلامات وتقليل وقت الاستجابة وتكاليف القراءة. يحتوي التطبيق على الفهارس التالية:

### الفهارس الأساسية

| المجموعة | الحقول | الغرض |
|----------|--------|-------|
| tasks | userId (تصاعدي) | تصفية المهام حسب المستخدم |
| users | role (تصاعدي) | تصفية المستخدمين حسب الدور |
| individuals | userId (تصاعدي) | ربط بيانات المستخدم الفردي |

### الفهارس المركبة

| المجموعة | الحقول | الغرض |
|----------|--------|-------|
| tasks | userId (تصاعدي), status (تصاعدي) | تصفية مهام المستخدم حسب الحالة |
| tasks | userId (تصاعدي), dueDate (تصاعدي) | تصفية مهام المستخدم حسب تاريخ الاستحقاق |
| tasks | userId (تصاعدي), createdAt (تصاعدي) | ترتيب مهام المستخدم حسب تاريخ الإنشاء (تصاعدي) |
| tasks | userId (تصاعدي), createdAt (تنازلي) | ترتيب مهام المستخدم حسب تاريخ الإنشاء (تنازلي) |
| tasks | userId (تصاعدي), priority (تصاعدي) | تصفية مهام المستخدم حسب الأولوية |
| tasks | userId (تصاعدي), status, priority, dueDate | استعلامات متعددة الشروط للتقارير والتخطيط |
| users | role (تصاعدي), name (تصاعدي) | ترتيب المستخدمين حسب الدور ثم الاسم |
| taskCategories | userId (تصاعدي), name (تصاعدي) | ترتيب فئات المهام حسب الاسم |
| organizationRequests | userId (تصاعدي), createdAt (تنازلي) | عرض طلبات المؤسسات للمستخدم |
| organizationRequests | status (تصاعدي), createdAt (تنازلي) | عرض طلبات المؤسسات حسب الحالة |
| organizationInvitations | userId (تصاعدي), createdAt (تنازلي) | عرض دعوات المؤسسات للمستخدم |

## تطبيق الفهارس

يتم تعريف الفهارس في ملف `firestore.indexes.json` في جذر المشروع. لتطبيق هذه الفهارس على مشروع Firebase:

```bash
firebase deploy --only firestore:indexes
```

## استراتيجيات تحسين الأداء الأخرى

### 1. استخدام الاستعلامات المُحسّنة

نستخدم استعلامات مُحسّنة تستفيد من الفهارس المُعرّفة:

```typescript
// استعلام مُحسّن باستخدام الفهارس
const tasksQuery = query(
  collection(db, 'tasks'),
  where('userId', '==', user.uid),
  orderBy('createdAt', 'desc')
);
```

### 2. تحديد حجم الاستعلامات

للاستعلامات التي قد ترجع عددًا كبيرًا من النتائج، نستخدم `limit()` لتحديد عدد النتائج:

```typescript
const tasksQuery = query(
  collection(db, 'tasks'),
  where('userId', '==', user.uid),
  orderBy('createdAt', 'desc'),
  limit(100) // تحديد عدد النتائج إلى 100
);
```

### 3. استخدام التصفح (Pagination)

للقوائم الطويلة، نستخدم التصفح لتحميل البيانات على دفعات:

```typescript
// استعلام الصفحة الأولى
const firstPageQuery = query(
  collection(db, 'tasks'),
  where('userId', '==', user.uid),
  orderBy('createdAt', 'desc'),
  limit(20)
);

// استعلام الصفحة التالية
const nextPageQuery = query(
  collection(db, 'tasks'),
  where('userId', '==', user.uid),
  orderBy('createdAt', 'desc'),
  startAfter(lastVisibleDocument),
  limit(20)
);
```

### 4. اختيار الحقول المطلوبة فقط

لتقليل حجم البيانات المنقولة، نستخدم `select()` لاسترجاع الحقول المطلوبة فقط:

```typescript
const summaryQuery = query(
  collection(db, 'tasks'),
  where('userId', '==', user.uid),
  select('description', 'status', 'dueDate')
);
```

### 5. استخدام التخزين المؤقت (Caching)

نستفيد من التخزين المؤقت في Firestore لتقليل عدد الطلبات:

```typescript
// تكوين التخزين المؤقت
const firestore = getFirestore();
enablePersistence(firestore, {
  synchronizeTabs: true
});
```

## تحسينات خاصة بالمستخدم المستقل

للمستخدم المستقل، تم تحسين الاستعلامات لضمان الأداء الأمثل:

1. **تصدير المهام**: استخدام فهرس مركب لتحسين أداء استعلام تصدير المهام.
2. **صفحة مؤشرات الأداء (KPI)**: استخدام فهرس مركب لتحسين أداء استعلامات التحليلات.
3. **استيراد المهام**: التحقق من صحة البيانات وتحسين عمليات الكتابة باستخدام الدفعات (batched writes).

## مراقبة الأداء

يمكن مراقبة أداء الاستعلامات والفهارس من خلال:

1. **وحدة تحكم Firebase**: توفر معلومات عن استخدام الفهارس وأداء الاستعلامات.
2. **سجلات Firebase**: تسجيل وقت تنفيذ الاستعلامات للتحليل.
3. **أدوات تطوير المتصفح**: مراقبة وقت استجابة الشبكة وحجم البيانات.

## الخلاصة

استخدام الفهارس المناسبة وتقنيات تحسين الأداء يضمن أن التطبيق سيعمل بكفاءة حتى مع نمو حجم البيانات وزيادة عدد المستخدمين. يجب مراجعة وتحديث استراتيجيات الفهرسة بانتظام مع تطور التطبيق وتغير أنماط الاستخدام.
