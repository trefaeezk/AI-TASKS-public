نظام إدارة المستخدمين والصلاحيات في تطبيق إدارة المهام
ملخص مختصر
يستخدم التطبيق Firebase Authentication لإدارة المستخدمين مع Custom Claims لتخزين الأدوار والصلاحيات. يتم تخزين بيانات المستخدمين الإضافية في Firestore، وتُنفذ عمليات إدارة الصلاحيات عبر Firebase Cloud Functions. يدعم النظام نوعين من الحسابات: فردية ومؤسسية، مع أدوار متعددة (مالك، مسؤول، مهندس، مشرف، فني، مساعد فني، مستخدم، مستقل).

التفاصيل الكاملة
1. بنية نظام المصادقة وإدارة المستخدمين
1.1 خدمات Firebase المستخدمة
Firebase Authentication: لتسجيل المستخدمين وتسجيل الدخول والخروج
Firestore Database: لتخزين بيانات المستخدمين الإضافية والإعدادات
Firebase Cloud Functions: لتنفيذ عمليات إدارة الصلاحيات والأدوار
1.2 أنواع الحسابات
حسابات فردية: للمستخدمين الأفراد
حسابات مؤسسية: للمستخدمين المنتمين لمؤسسة
1.3 هيكل البيانات
مجموعة users: تخزن معلومات جميع المستخدمين
مجموعة individuals: تخزن معلومات المستخدمين الفرديين
مجموعة organizations: تخزن معلومات المؤسسات
مجموعة فرعية members: تخزن معلومات أعضاء كل مؤسسة
مجموعة organizationRequests: تخزن طلبات إنشاء المؤسسات
2. الأدوار والصلاحيات
2.1 الأدوار المتاحة
مالك النظام (owner): يمتلك جميع الصلاحيات بما فيها إدارة المؤسسات
مسؤول (admin): يمتلك صلاحيات إدارية واسعة
مسؤول نظام الأفراد (individual_admin): يدير حسابات المستخدمين الفرديين
مهندس (engineer): يمتلك صلاحيات فنية متقدمة
مشرف (supervisor): يشرف على المهام والفنيين
فني (technician): ينفذ المهام الفنية
مساعد فني (assistant): يساعد الفنيين
مستخدم (user): صلاحيات أساسية
مستخدم مستقل (independent): مستخدم فردي مستقل
2.2 آلية تخزين الصلاحيات
Custom Claims: تُخزن في Firebase Authentication وتشمل:
role: دور المستخدم
owner: إذا كان مالك<|im_start|> (true/false)
admin: إذا كان مسؤولاً (true/false)
individual_admin: إذا كان مسؤول نظام الأفراد (true/false)
accountType: نوع الحساب (individual/organization)
organizationId: معرف المؤسسة (للحسابات المؤسسية)
departmentId: معرف القسم (للحسابات المؤسسية)
وثيقة المستخدم في Firestore: تخزن معلومات إضافية مثل:
role: دور المستخدم
isOwner: إذا كان مالك س
isAdmin: إذا كان مسؤولاً
customPermissions: صلاحيات مخصصة إضافية
name: اسم المستخدم
email: البريد الإلكتروني
createdAt: تاريخ الإنشاء
lastLogin: تاريخ آخر تسجيل دخول
2.3 نظام الصلاحيات المفصل
الصلاحيات مقسمة إلى مناطق وإجراءات:

مناطق الصلاحيات:
users: إدارة المستخدمين
tasks: إدارة المهام
reports: التقارير
settings: الإعدادات
tools: الأدوات
dashboard: لوحة المعلومات
data: إدارة البيانات
إجراءات الصلاحيات:
view: عرض
create: إنشاء
edit: تعديل
delete: حذف
approve: اعتماد
assign: تعيين
3. عمليات إدارة المستخدمين
3.1 إنشاء المستخدمين
دالة createUser: تنشئ مستخدماً جديداً مع تحديد الدور ونوع الحساب
التحقق من صلاحيات المستخدم المنشئ (يجب أن يكون مسؤولاً)
التحقق من صحة البيانات المدخلة
إنشاء المستخدم في Firebase Authentication
إنشاء وثيقة المستخدم في Firestore
3.2 تعيين الأدوار
دالة setOwnerRole: تعيين مستخدم كمالك للنظام
دالة setAdminRole: تعيين مستخدم كمسؤول
دالة setUserDisabledStatus: تعطيل/تفعيل حساب مستخدم
دالة setOwnerDirectHttp: تعيين مستخدم كمالك بشكل مباشر (للحالات الطارئة)
3.3 إدارة الصلاحيات المخصصة
واجهة PermissionsManager: لإدارة الصلاحيات المخصصة
تخزين الصلاحيات المخصصة في حقل customPermissions في وثيقة المستخدم
دالة updateUserPermissions: لتحديث صلاحيات مستخدم معين
3.4 تحديث معلومات المستخدم
دالة refreshUserData: لتحديث معلومات المستخدم وصلاحياته
استخدام getIdTokenResult مع force refresh لتحديث Custom Claims
مستمع Firestore لتحديث معلومات المستخدم عند تغيير وثيقته
4. إدارة المؤسسات
4.1 إنشاء المؤسسات
دالة createOrganizationRequest: لإنشاء طلب إنشاء مؤسسة
تخزين الطلب في مجموعة organizationRequests
يمكن للمستخدمين العاديين إنشاء طلبات
4.2 الموافقة على المؤسسات
دالة approveOrganizationRequest: للموافقة على طلب إنشاء مؤسسة
دالة rejectOrganizationRequest: لرفض طلب إنشاء مؤسسة
يتطلب صلاحية المالك للموافقة أو الرفض
إنشاء وثيقة المؤسسة في مجموعة organizations عند الموافقة
إضافة المستخدم المنشئ كعضو في المؤسسة
4.3 إدارة أعضاء المؤسسة
إضافة أعضاء للمؤسسة من قبل مسؤولي المؤسسة
تحديد أدوار الأعضاء داخل المؤسسة
تخزين معلومات العضوية في المجموعة الفرعية members
5. واجهة المستخدم لإدارة المستخدمين
5.1 صفحة الإدارة الرئيسية
عرض قائمة المستخدمين
إمكانية تعديل أدوار المستخدمين
إمكانية تعطيل/تفعيل المستخدمين
إمكانية تعيين مستخدم كمالك
5.2 صفحة طلبات المؤسسات
عرض طلبات إنشاء المؤسسات
إمكانية الموافقة أو رفض الطلبات
متاحة فقط للمالك
5.3 مدير الصلاحيات
واجهة لتعديل صلاحيات المستخدمين
إمكانية تخصيص صلاحيات مختلفة عن الافتراضية للدور
عرض الصلاحيات حسب المناطق والإجراءات
6. آلية تحديث الصلاحيات
6.1 تحديث Custom Claims
استدعاء setCustomUserClaims من Firebase Admin SDK
تحديث Custom Claims يتطلب تسجيل الخروج وإعادة تسجيل الدخول لتفعيلها
أو استخدام getIdTokenResult مع force refresh
6.2 تحديث وثيقة المستخدم
تحديث وثيقة المستخدم في Firestore
استخدام مستمع لتغييرات وثيقة المستخدم لتحديث الواجهة
6.3 معالجة مشكلات الصلاحيات
زر تحديث الصلاحيات لتحديث معلومات المستخدم
زر تسجيل الخروج وإعادة تسجيل الدخول لتحديث الجلسة
دالة setOwnerDirectHttp للحالات الطارئة
7. أمان النظام
7.1 التحقق من الصلاحيات
دالة ensureAdmin: للتحقق من أن المستخدم مسؤول
دالة ensureOwner: للتحقق من أن المستخدم مالك
دالة ensureUserOwnership: للتحقق من ملكية المستخدم للبيانات
7.2 حماية الوظائف السحابية
التحقق من المصادقة قبل تنفيذ أي عملية
التحقق من الصلاحيات المناسبة لكل عملية
تسجيل جميع العمليات للمراجعة
7.3 فصل البيانات
فصل بيانات المستخدمين الفرديين عن بيانات المؤسسات
التحقق من نوع الحساب قبل الوصول إلى البيانات
قواعد أمان Firestore للتحكم في الوصول إلى البيانات
8. تحسينات وإصلاحات
8.1 إصلاح مشكلات الصلاحيات
تحسين دالة refreshUserData لتكون أكثر فعالية
إضافة طرق متعددة لتعيين المستخدم كمالك
تحسين عرض معلومات المستخدم للتشخيص
8.2 تحسين تجربة المستخدم
إضافة رسائل توضيحية عند تغيير الصلاحيات
إضافة أزرار لتسهيل إدارة الصلاحيات
عرض معلومات المستخدم الحالية بشكل مفصل
8.3 تنظيف البيانات
التحقق من وجود المستخدمين في Firebase Authentication قبل عرضهم
حذف المستخدمين المحذوفين من قواعد البيانات
مزامنة البيانات بين Firebase Authentication و Firestore
